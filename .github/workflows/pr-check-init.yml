name: Initialize PR Checks

permissions:
  checks: write
  pull-requests: read

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  initialize-checks:
    name: ğŸš€ Initialize PR Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“ Create initial check runs
        uses: actions/github-script@v7
        with:
          script: |
            const checkNames = [
              'Smoke Tests',
              'CI Checks',
              'Core Tests',
              'Quality Tests',
              'API Tests',
              'E2E Tests (chromium)',
              'E2E Tests (firefox)', 
              'E2E Tests (webkit)',
              'E2E Tests (mobile-chrome)',
              'E2E Tests (mobile-safari)'
            ];

            const sha = context.payload.pull_request.head.sha;

            core.info(`Creating initial check runs for PR #${context.payload.pull_request.number}`);
            core.info(`SHA: ${sha}`);

            // Create all check runs in parallel
            const checkPromises = checkNames.map(async (checkName) => {
              try {
                const { data: checkRun } = await github.rest.checks.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: checkName,
                  head_sha: sha,
                  status: 'queued',
                  output: {
                    title: `ğŸ”„ ${checkName} - Queued`,
                    summary: `${checkName} has been queued and will start when ready.`
                  },
                  details_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/pull/${context.payload.pull_request.number}`
                });
                
                core.info(`âœ… Created check: ${checkName} (ID: ${checkRun.id})`);
                return { name: checkName, id: checkRun.id, status: 'created' };
              } catch (error) {
                core.error(`âŒ Failed to create check ${checkName}: ${error.message}`);
                return { name: checkName, status: 'failed', error: error.message };
              }
            });

            const results = await Promise.all(checkPromises);

            // Log results
            const successful = results.filter(r => r.status === 'created');
            const failed = results.filter(r => r.status === 'failed');

            core.info(`Successfully created ${successful.length} check runs`);
            if (failed.length > 0) {
              core.warning(`Failed to create ${failed.length} check runs`);
              failed.forEach(f => core.warning(`  - ${f.name}: ${f.error}`));
            }

            // Create enhanced summary
            await core.summary
              .addHeading('ğŸš€ PR Check Initialization')
              .addTable([
                ['Check Name', 'Category', 'Status'],
                ['Smoke Tests', 'ğŸ”¥ Critical Path', successful.find(r => r.name === 'Smoke Tests') ? 'âœ… Created' : 'âŒ Failed'],
                ['CI Checks', 'ğŸ”§ Build & Test', successful.find(r => r.name === 'CI Checks') ? 'âœ… Created' : 'âŒ Failed'],
                ['Core Tests', 'ğŸ§ª Unit Testing', successful.find(r => r.name === 'Core Tests') ? 'âœ… Created' : 'âŒ Failed'],
                ['Quality Tests', 'ğŸ›¡ï¸ QA & Security', successful.find(r => r.name === 'Quality Tests') ? 'âœ… Created' : 'âŒ Failed'],
                ['API Tests', 'ğŸŒ API Health', successful.find(r => r.name === 'API Tests') ? 'âœ… Created' : 'âŒ Failed'],
                ['E2E Tests (chromium)', 'ğŸŒ Integration', successful.find(r => r.name === 'E2E Tests (chromium)') ? 'âœ… Created' : 'âŒ Failed'],
                ['E2E Tests (firefox)', 'ğŸ¦Š Cross-browser', successful.find(r => r.name === 'E2E Tests (firefox)') ? 'âœ… Created' : 'âŒ Failed'],
                ['E2E Tests (webkit)', 'ğŸ Safari/WebKit', successful.find(r => r.name === 'E2E Tests (webkit)') ? 'âœ… Created' : 'âŒ Failed'],
                ['E2E Tests (mobile-chrome)', 'ğŸ“± Mobile Chrome', successful.find(r => r.name === 'E2E Tests (mobile-chrome)') ? 'âœ… Created' : 'âŒ Failed'],
                ['E2E Tests (mobile-safari)', 'ğŸ“± Mobile Safari', successful.find(r => r.name === 'E2E Tests (mobile-safari)') ? 'âœ… Created' : 'âŒ Failed']
              ])
              .addSeparator()
              .addRaw(`
              <details>
              <summary>ğŸ“‹ Pipeline Execution Order</summary>
              
              **Phase 1: Fast Feedback (1-2 minutes)**
              1. ğŸ”¥ **Smoke Tests** - Critical path validation
              
              **Phase 2: Core Validation (5-10 minutes)**
              2. ğŸ”§ **CI Checks** - Linting, type-check, Jest tests, build
              
              **Phase 3: Comprehensive Testing (Parallel - 10-20 minutes)**
              3. ğŸ§ª **Core Tests** - Component functionality testing
              4. ğŸ›¡ï¸ **Quality Tests** - Accessibility, performance, security
              5. ğŸŒ **API Tests** - API health and integration
              
              **Phase 4: Integration Testing (After Vercel deployment)**
              6. ğŸŒ **E2E Tests** - Cross-browser integration testing
              
              </details>
              `)
              .addQuote(`âœ¨ PR #${context.payload.pull_request.number} is ready for the enhanced CI/CD pipeline with reorganized test structure!`)
              .write();

      - name: ğŸ“‹ Log PR information
        run: |
          echo "## PR Information" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Head SHA:** ${{ github.event.pull_request.head.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Base Branch:** ${{ github.event.pull_request.base.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Head Branch:** ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Enhanced CI/CD Pipeline Features" >> $GITHUB_STEP_SUMMARY
          echo "- **Organized Test Structure:** Tests are now categorized (core, integration, quality, api, deployment)" >> $GITHUB_STEP_SUMMARY
          echo "- **Faster Feedback:** Smoke tests provide immediate validation" >> $GITHUB_STEP_SUMMARY
          echo "- **Parallel Execution:** Quality and API tests run in parallel for speed" >> $GITHUB_STEP_SUMMARY
          echo "- **Comprehensive Coverage:** Accessibility, performance, security, and responsive testing" >> $GITHUB_STEP_SUMMARY
          echo "- **Smart Dependencies:** Tests run in optimal order with proper dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. âš¡ Smoke tests will run immediately for fast feedback" >> $GITHUB_STEP_SUMMARY
          echo "2. ğŸ”§ CI checks will validate code quality and build" >> $GITHUB_STEP_SUMMARY
          echo "3. ğŸ§ª Core and quality tests will run in parallel" >> $GITHUB_STEP_SUMMARY
          echo "4. ğŸŒ E2E tests will run after Vercel preview deployment" >> $GITHUB_STEP_SUMMARY
          echo "5. âœ… Auto-merge will trigger when all checks pass" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Validate test structure
        run: |
          echo "## ğŸ§ª Test Structure Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if new test structure exists
          if [ -d "tests/core" ] && [ -d "tests/integration" ] && [ -d "tests/quality" ]; then
            echo "âœ… **New test structure detected**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“ \`tests/core/\` - Component tests" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“ \`tests/integration/\` - User workflow tests" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“ \`tests/quality/\` - Accessibility, performance, security" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“ \`tests/api/\` - API health and integration" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“ \`tests/deployment/\` - Production validation" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“ \`tests/utils/\` - Shared test utilities" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Legacy test structure detected**" >> $GITHUB_STEP_SUMMARY
            echo "Consider migrating to the new organized structure for better maintainability." >> $GITHUB_STEP_SUMMARY
          fi

          # Check if old tests are preserved
          if [ -d "old-tests" ]; then
            echo "ğŸ“¦ **Legacy tests preserved in \`old-tests/\` directory**" >> $GITHUB_STEP_SUMMARY
          fi
